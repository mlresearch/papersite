---
author: "Neil D. Lawrence"
created: "2025-10-05"
id: "0003"
last_updated: "2025-10-05"
status: proposed
tags:
- cip
- bibtex
- data-quality
- preprocessing
title: "BibTeX File Format Validation and Cleaning"
---

# CIP-0003: BibTeX File Format Validation and Cleaning

## Summary
This CIP proposes adding a BibTeX file format validation and cleaning script as a preprocessing step for volume creation. The script would check for common BibTeX formatting issues like unescaped % characters and malformed author fields, providing automated fixes where appropriate.

## Motivation
BibTeX files often contain formatting issues that prevent successful volume creation:

1. **Unescaped % characters**: % characters in abstract and title fields need to be escaped as \% to prevent BibTeX parsing errors
2. **Malformed author fields**: Empty author fields with double commas cause parsing failures
3. **Data validation**: Need automated detection of common BibTeX formatting issues

These issues cause parsing errors and prevent the volume creation script from completing successfully. A preprocessing validation step would catch these issues before volume creation begins.

## Detailed Description
This CIP proposes adding a BibTeX file format validation script (`lib/tidy_bibtex.rb`) as a preprocessing step for volume creation. The script would check for common BibTeX formatting issues and provide automated fixes where appropriate.

### Key Features
- **% character validation**: Check for unescaped `%` characters in abstract and title fields
- **Author field validation**: Detect empty author fields and malformed author lists
- **Comprehensive reporting**: Show exact line numbers and issue counts
- **Safe operation**: Create new files rather than modifying originals

### Command Line Options
- `--fix-percent`: Automatically escape unescaped `%` characters in abstract and title fields
- `--check-author-commas`: Report empty author fields for manual review
- `--strict`: Fail on any issues found
- `--verbose`: Detailed output
- `--interactive`: Interactive mode for fixing issues

## Implementation Plan
1. **Script Development**:
   - Create `lib/tidy_bibtex.rb` with BibTeX validation capabilities
   - Implement % character checking and fixing logic
   - Add author field validation and reporting

2. **Integration**:
   - Add as preprocessing step in volume creation workflow
   - Provide options for automated vs. manual processing
   - Integrate with existing volume creation scripts

## Pipeline Integration
The BibTeX validation script will be integrated into the volume creation pipeline as follows:

1. **Pre-processing Step**: Run `tidy_bibtex.rb` before `create_volume.rb`
2. **Workflow Integration**: 
   - Add validation step to `create_volume.rb` with `--validate-bibtex` flag
   - Provide option to auto-fix issues or report for manual review
   - Create cleaned BibTeX file for downstream processing
3. **Error Handling**: 
   - Fail fast if critical issues found (with `--strict` flag)
   - Provide detailed reporting of issues found
   - Allow bypass with `--skip-validation` for known good files

3. **Testing and Validation**:
   - Test with sample BibTeX files containing common issues
   - Validate fixes on % character issues
   - Ensure no data corruption during cleaning

## Backward Compatibility
This change is fully backward compatible. The cleaning script creates new files rather than modifying originals, and all existing functionality remains unchanged. Users can choose to use the cleaned files or continue with original files.

## Testing Strategy
- **Unit Testing**: Test individual validation functions with sample BibTeX entries
- **Integration Testing**: Test as preprocessing step in volume creation workflow
- **Regression Testing**: Verify that cleaned files produce identical results to manually fixed files
- **Performance Testing**: Ensure script handles large volumes efficiently

## Related Requirements
This CIP addresses the following requirements:

- **Data Quality**: Ensures BibTeX files meet processing requirements
- **Preprocessing**: Validates input files before volume creation
- **Error Prevention**: Prevents script failures due to data quality issues

Specifically, it implements solutions for:
- % character validation and fixing in abstracts and titles
- Author field validation and reporting
- Comprehensive issue detection and reporting
- Safe file processing with backup creation

## Implementation Status
- [x] Create BibTeX validation script with core functionality
- [x] Implement % character checking and fixing
- [x] Add author field validation
- [x] Test with sample BibTeX files
- [ ] Document usage and integration
- [ ] Add as preprocessing step to volume creation workflow
- [x] Create comprehensive test suite
- [ ] Add configuration options

## Current Implementation
The BibTeX cleaning script (`lib/tidy_bibtex.rb`) has been created with the following features:

### Implemented Features
- **% Character Detection and Fixing**: Automatically detects and fixes unescaped `%` characters in abstract and title fields
- **Author Field Validation**: Reports empty author fields (double commas) for manual review
- **Comprehensive Command Line Interface**: Supports `--fix-percent`, `--check-author-commas`, `--strict`, `--verbose`, `--interactive`, and `--fix-all` options
- **Safe File Processing**: Creates new output files rather than modifying originals
- **Detailed Reporting**: Shows exact line numbers and issue counts

### Pending Tasks
- **Testing**: Need to test with actual BibTeX files containing issues
- **Integration**: Add as preprocessing step to volume creation workflow
- **Documentation**: Complete usage documentation and examples
- **Validation**: Ensure script handles edge cases correctly

## References
- **Files to be Created**: `lib/tidy_bibtex.rb`
- **Related Issues**: BibTeX parsing errors during volume creation
- **Documentation**: BibTeX specification compliance requirements
- **Integration**: Volume creation workflow